# 广告过滤优化说明

## 问题描述

用户反馈在第一次打开网站时会看到广告内容（特别是 swiper-slide 轮播广告），需要刷新页面才能去除。具体表现为：

```html
<div class="swiper-slide csp swiper-slide-prev" data-swiper-autoplay="15000" data-swiper-slide-index="0" style="width: 982px; transition-duration: 300ms; opacity: 1; transform: translate3d(-982px, 0px, 0px);">
    <img src="https://static.olelive.com/uploads/file/8156aaacd49ad5a62d2167e99b6f17fc_20250712224237.jpg" alt="png">
    <div class="pc-mask swiper-mask-circle"></div>
</div>
```

## 解决方案

### 1. 服务器端过滤增强

在 `replace_domain_in_content` 函数中添加了针对 swiper-slide 广告的专门过滤规则：

```python
ad_patterns = [
    # 您提到的具体swiper-slide广告模式（最优先匹配）
    r'<div[^>]*class="[^"]*swiper-slide[^"]*csp[^"]*"[^>]*data-swiper-autoplay="[^"]*"[^>]*>.*?<img[^>]*src="[^"]*static\.olelive\.com\/uploads\/file\/[^"]*"[^>]*>.*?<div[^>]*class="[^"]*pc-mask[^"]*swiper-mask-circle[^"]*"[^>]*></div>\s*</div>',
    # 通用swiper-slide广告容器
    r'<div[^>]*class="[^"]*swiper-slide[^"]*"[^>]*data-swiper-autoplay="[^"]*"[^>]*>.*?<img[^>]*src="[^"]*static\.olelive\.com\/uploads\/file\/[^"]*"[^>]*>.*?</div>',
    r'<div[^>]*class="[^"]*swiper-slide[^"]*"[^>]*>.*?<img[^>]*src="[^"]*static\.olelive\.com\/uploads\/file\/[^"]*"[^>]*>.*?</div>',
    # ... 其他广告模式
]
```

### 2. 客户端脚本优化

#### 2.1 立即执行的CSS隐藏规则

在页面加载的最早阶段就注入CSS规则，立即隐藏广告元素：

```css
[class*="pc-ads"],
.swiper-slide:has(img[src*="static.olelive.com/uploads/file/"]),
.swiper-slide img[src*="static.olelive.com/uploads/file/"],
a[href*="2032.sfdzxvcbdfhg2032.cc"],
a[href*="tjh121e721.xn--9kqv5am2jbz1a.com"],
img[src*="static.olelive.com/uploads/file/"] {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    width: 0 !important;
    height: 0 !important;
    position: absolute !important;
    left: -9999px !important;
}
```

#### 2.2 网络请求拦截

拦截 fetch 和 XMLHttpRequest 请求，阻止广告资源的加载：

```javascript
// 拦截 fetch
const originalFetch = window.fetch;
window.fetch = function(...args) {
    const url = args[0];
    if (typeof url === 'string' && adPaths.some(path => url.includes(path))) {
        return Promise.resolve(new Response('', {status: 204}));
    }
    return originalFetch.apply(this, args);
};

// 拦截 XMLHttpRequest
const originalXHROpen = XMLHttpRequest.prototype.open;
XMLHttpRequest.prototype.open = function(method, url, ...args) {
    if (typeof url === 'string' && adPaths.some(path => url.includes(path))) {
        url = 'data:text/plain;base64,';
    }
    return originalXHROpen.call(this, method, url, ...args);
};
```

#### 2.3 实时DOM监控

使用 MutationObserver 实时监控DOM变化，立即移除新增的广告元素：

```javascript
const observer = new MutationObserver(mutations => {
    mutations.forEach(mutation => {
        mutation.addedNodes.forEach(node => {
            if (node.nodeType === 1) {
                // 立即检查并移除广告元素
                if (node.matches && (
                    node.matches('[class*="pc-ads"]') ||
                    (node.matches('.swiper-slide') && node.querySelector('img[src*="static.olelive.com/uploads/file/"]')) ||
                    node.matches('img[src*="static.olelive.com/uploads/file/"]') ||
                    node.matches('a[href*="2032.sfdzxvcbdfhg2032.cc"]') ||
                    node.matches('a[href*="tjh121e721.xn--9kqv5am2jbz1a.com"]')
                )) {
                    node.remove();
                    return;
                }
            }
        });
    });
});
```

#### 2.4 多时机清理

在多个时间点执行清理，确保覆盖所有可能的加载时机：

```javascript
setTimeout(cleanAds, 0);      // 立即
setTimeout(cleanAds, 100);    // 100ms后
setTimeout(cleanAds, 500);    // 500ms后
setTimeout(cleanAds, 1000);   // 1秒后
setTimeout(cleanAds, 2000);   // 2秒后（处理延迟加载的广告）
```

### 3. 脚本注入位置优化

将广告过滤脚本注入到 `<head>` 标签的开始位置，确保在页面渲染前就开始工作：

```python
# 在<head>标签开始后立即插入（确保最早执行）
if '<head>' in content:
    content = content.replace('<head>', '<head>' + ad_blocker_js)
elif '</head>' in content:
    content = content.replace('</head>', ad_blocker_js + '</head>')
else:
    # 如果没有head标签，在html开始后插入
    content = content.replace('<html', ad_blocker_js + '<html', 1)
```

## 测试验证

创建了测试页面 `test_ad_filter.html` 来验证广告过滤功能，包含：

1. swiper-slide 轮播广告测试
2. pc-ads 广告容器测试
3. 广告图片测试
4. 广告域名链接测试
5. 动态添加广告内容测试

## 效果

- ✅ 用户第一次打开页面时不会看到广告
- ✅ 服务器端预过滤减少网络传输
- ✅ 客户端多层防护确保完全拦截
- ✅ 实时监控防止动态加载的广告
- ✅ 网络请求拦截节省带宽

## 性能优化

- 使用编译后的正则表达式提高服务器端过滤性能
- CSS规则立即生效，避免闪烁
- 减少定时清理频率，降低CPU占用
- 白名单机制保护重要页面元素

## 注意事项

- 保持对重要页面元素的保护（搜索框、导航等）
- 定期更新广告域名和模式
- 监控过滤效果和性能影响 